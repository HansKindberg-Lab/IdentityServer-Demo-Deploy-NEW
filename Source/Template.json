{
	"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"appServiceName": {
			"type": "string"
		},
		"signingCertificate": {
			"type": "securestring"
		},
		"signingCertificateName": {
			"type": "securestring"
		},
		"signingCertificatePassword": {
			"type": "securestring"
		},
		"sithsRootCertificate": {
			"metadata": {
				"description": "The text-content of the 'SITHS e-id Root CA v2.crt' file."
			},
			"type": "securestring"
		}
	},
	"variables": {
		"apiVersion": "2019-08-01",
		"appServiceKind": "app,linux,container",
		"appServicePlanName": "App-Service-Plan",
		"mtlsAppServiceName": "[concat(parameters('appServiceName'), '-mtls')]",
		"serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
		"siteConfig": {
			"appSettings": [
				{
					"name": "DOCKER_ENABLE_CI",
					"value": "true",
					"slotSetting": false
				},
				{
					"name": "DOCKER_REGISTRY_SERVER_URL",
					"value": "https://index.docker.io"
				}
			],
			"linuxFxVersion": "DOCKER|hanskindberg/identity-server:latest",
			"minTlsVersion": "1.2"
		},
		"sithsRootCertificateName": "SITHS e-id Root CA v2"
	},
	"resources": [
		{
			"name": "[variables('appServicePlanName')]",
			"apiVersion": "[variables('apiVersion')]",
			"kind": "linux",
			"location": "[resourceGroup().location]",
			"properties": {
				"reserved": true
			},
			"sku": {
				"name": "S1",
				"tier": "Standard"
			},
			"type": "Microsoft.Web/serverfarms"
		},
		{
			"name": "[parameters('appServiceName')]",
			"apiVersion": "[variables('apiVersion')]",
			"dependsOn": [
				"[variables('serverFarmId')]"
			],
			"kind": "[variables('appServiceKind')]",
			"location": "[resourceGroup().location]",
			"properties": {
				"httpsOnly": true,
				"serverFarmId": "[variables('serverFarmId')]",
				"siteConfig": "[variables('siteConfig')]"
			},
			"type": "Microsoft.Web/sites"
		},
		{
			"name": "[variables('mtlsAppServiceName')]",
			"apiVersion": "[variables('apiVersion')]",
			"dependsOn": [
				"[variables('serverFarmId')]"
			],
			"kind": "[variables('appServiceKind')]",
			"location": "[resourceGroup().location]",
			"properties": {
				"clientCertEnabled": true,
				"clientCertMode": "Required",
				"httpsOnly": true,
				"serverFarmId": "[variables('serverFarmId')]",
				"siteConfig": "[variables('siteConfig')]"
			},
			"type": "Microsoft.Web/sites"
		},
		{
			"name": "[parameters('signingCertificateName')]",
			"apiVersion": "[variables('apiVersion')]",
			"dependsOn": [
				"[resourceId('Microsoft.Web/sites', parameters('appServiceName'))]",
				"[resourceId('Microsoft.Web/sites', variables('mtlsAppServiceName'))]"
			],
			"location": "[resourceGroup().location]",
			"properties": {
				"password": "[parameters('signingCertificatePassword')]",
				"pfxBlob": "[parameters('signingCertificate')]",
				"serverFarmId": "[variables('serverFarmId')]"
			},
			"type": "Microsoft.Web/certificates"
		},
		{
			"name": "[concat(variables('mtlsAppServiceName'), '/', variables('sithsRootCertificateName'))]",
			"apiVersion": "[variables('apiVersion')]",
			"dependsOn": [
				"[resourceId('Microsoft.Web/sites', variables('mtlsAppServiceName'))]"
			],
			"properties": {
				"blob": "[parameters('sithsRootCertificate')]",
				"publicCertificateLocation": "CurrentUserMy"
			},
			"type": "Microsoft.Web/sites/publicCertificates"
		}
	]
}